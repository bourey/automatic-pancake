<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" charset="UTF-8">
    const stemChangingVerbs = [
      { e: 'to plan', s: 'pensar', c: ['pienso', 'piensas', 'piensa', 'piensan', 'pensamos'] },
      { e: 'to go', s: 'ir', c: ['voy', 'vas', 'va', 'van', 'vamos']},
      { e: 'to want', s: 'querer', c: ['quiero', 'quieres', 'quiere', 'quieren', 'queremos']},
      { e: 'sleep', s: 'dormir', c: ['duermo', 'duermes', 'duerme', 'duermen', 'dormemos'] },
    ];
    const standardVerbs = [
      { e: 'dance', s: 'bailar', c: ['bailo', 'bailas', 'baila', 'bailan', 'bailamos'] },
      { e: 'to sing', s: 'cantar', c: ['canto', 'cantas', 'canta', 'cantan', 'cantamos'] },
      { e: 'buy', s: 'comprar', c: ['compro', 'compras', 'compra', 'compran', 'compramos'] },
      { e: 'visit', s: 'visitar', c: ['visito', 'visitas', 'visita', 'visitan', 'visitamos'] },
      { e: 'eat', s: 'comer', c: ['como', 'comes', 'come', 'comen', 'comemos'] },
      { e: 'do', s: 'hacer', c: ['hago', 'haces', 'hace', 'hacen', 'hacemos'] },
      { e: 'open', s: 'abrir', c: ['abro', 'abres', 'abre', 'abren', 'abremos'] },
      { e: 'say', s: 'decir', c: ['digo', 'dices', 'dice', 'dicen', 'dicemos'] },
    ];

    function getRandom(opts) {
      return opts[Math.floor(Math.random() * opts.length)];
    }

    function getNewOpt(lastOpt, opts) {
      const opt = getRandom(opts);
      if (lastOpt && lastOpt.e === opt.e) {
        return getNewOpt();
      } else {
        return opt;
      }
    }

    let opts;
    function updateOpts() {
      opts = [];
      if ($('#stemCheck').prop('checked')) {
        opts = opts.concat(stemChangingVerbs);
      }
      if ($('#standardCheck').prop('checked')) {
        opts = opts.concat(standardVerbs);
      }
    }

    let opt, submitted, submittedCorrectly, lastOpt;
    function reset() {
      submittedCorrectly = false;
      lastOpt = opt;
      opt = getNewOpt(lastOpt, opts);
      $('#word').text(opt.s + ' (' + opt.e + ')');
      $('.answer').text('');
      $('input').val('').removeClass('correct').removeClass('incorrect');
      $('input:first').focus();
    }

    function addChar(char, correct) {
      return $('<span/>').text(char).addClass(correct ? 'correct' : 'incorrect');
    }

    function init() {
      updateOpts();
      $('#stemCheck').change(updateOpts);
      $('#standardCheck').change(updateOpts);
      $('form').submit(function (e) {
        e.preventDefault();
        let correct = true;
        $('.question').each(function(i, q) { 
          const input = $(q).find('input');
          let attempt = input.val();
          attempt = attempt.replace(/([aeiou])\'/, function (match, p1) {
            switch (p1) {
              case 'a':
                return 'á';
              case 'e':
                return 'é';
              case 'i':
                return 'í';
              case 'o':
                return 'ó';
              case 'u':
                return 'ú';
              default:
                return p1;
            }
          });
          attempt = attempt.replace('n~', 'ñ')
          input.val(attempt);
          
          const answer = opt.c[i];
          const answerP = $(q).find('.answer');
          if (attempt === answer) {
            answerP.text('')
            input.removeClass('incorrect').addClass('correct');
          } else {
            correct = false;
            let j = 0;
            answerP.text('');
            while (j <= answer.length) {
              if (j <= attempt.length && attempt.charAt(j) === answer.charAt(j)) {
                answerP.append(addChar(answer.charAt(j), true));
              } else {
                answerP.append(addChar(answer.charAt(j), false));
              }
              j++;
            }
            input.addClass('incorrect');
          }
        });
        if (correct) {
          if (submittedCorrectly) {
            reset();
          } else {
            submittedCorrectly = true;
          }
        }
        
      });
      reset();
    }

    window.onload = init;
  </script>
  <style>
    p,
    input {
      font-family: sans-serif;
      font-size: 24px;
    }

    .incorrect {
      color: red;
    }
    .correct {
      color: green;
    }

    input.correct {
      outline: green;
    }

    input.incorrect {
      outline: red;
    }

    .options {
      position: absolute;
      top: 0;
      right: 0;
      padding: 10px;
      border: thin solid black;
    }
  </style>
</head>

<body>
  <h1 id="word"></h1>
  <form>
    <div class="question">
      <p>Yo <input name="i" size="50">
      <p class="answer">
    </div>
    <div class="question">
      <p>Tú <input name="you" size="50">
      <p class="answer">
    </div>
    <div class="question">
      <p>El / Ella <input name="she" size="50">
      <p class="answer">
    </div>
    <div class="question">
      <p>Ellos <input name="they" size="50">
      <p class="answer">
    </div>
    <div class="question">
      <p>Nosotros <input name="we" size="50">
      <p class="answer">
    </div>
    <button type="submit">Submit</button>
  </form>
  <div class="options">
    <input type="checkbox" id="stemCheck" name="stem" checked> Stem-changing verbs<br/>
    <input type="checkbox" id="standardCheck" name="standard" checked> Standard verbs<br/>
    <button onclick="reset()">Reset</button>
  </div>
</body>

</html>